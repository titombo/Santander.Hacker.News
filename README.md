# Santander.Hacker.News
=============================

Author's notes for this solution
--------

Hello! This is a sample solution for a coding exercise involving the Hacker News API.
There are many things to consider in here:
    - I have used Copilot to help me - as you can notice in some parts - and I as informed is not a problem to use it.
    - Also, since there is not a strict time limit I tried to cover as max. as I can of different aspects of this solution.
    - My comments have TM (Tito Morais) added to the code, you will find in different places - so you can differentiate from copilot and my comments
    - I always double-check the code generated by Copilot, and I make sure I understand the core concepts of it.
    - The architecture and how the solution is structured is something I have designed myself.
    - Part of this README.md is generated by me, part of it is generated by Copilot, and I have edited it to make sure it makes sense.
    - If I had more time I would spend more time on testing, integration testing, and load testing.

So basically this is a solution that returns the top N "best" stories from Hacker News, sorted by score.
I have used .Net 8, Minimal APIs, AutoMapper, in-memory caching, and a simple per-client rate limiter.

For this part of requirements:
    You should share a public repository with us, that should include a README.md file which describes how to run the application, any assumptions you have made, and
    any enhancements or changes you would make, given the time.

I am going to explain partially what I tought in each day and what was coming to my mind throught this time:

Day 1:
I started coding it yesterday, 17/11/2025 after work, at 20:00 and finished at around 23:30.
In terms of architecture, I have separated the solution into layers: Repository, Service, and Web-layer.
It is using Docker for portability, it is using the out-of-the-box when creating a new solution with minial-API.
This is a layered architecture-style that is easy to understand, but this solution can be used as part of a service-based architecture, microservice architecture, etc...
I started using minimal API because there are not so many endpoints, and we don't need the full capabilities of Web API controllers.
After creating the architecture and having in my mind what should be in each project, I started doing the basic of the endpoint, after adding the Domain, after the Repository and at the Services.
After that, I added AutoMapper to map the domain models to view models.
Later I added rate-limiting to the endpoint.

For this part of requirements:
    In addition to the above, your API should be able to efficiently service large numbers of requests without risking overloading of the Hacker News API.

We have:
    - caching for efficiency, to avoid calling the Hacker News API too often.
    - rate-limiting to avoid overloading the Hacker News API.
    - Semaphoreslim to limit the number of concurrent requests to the Hacker News API.
    - HttpClientFactory to manage the HttpClient instances efficiently.
    - Async/await to avoid blocking threads.
    - locked collections - maybe we could use ConcurrentList or ConcurrentDictionary, but I have used simple lists with locks for simplicity.

Day 2:

Today, 18/11/2025, I started at around 09:30 (now is 12:13, lunch break from my work - I took this spare time to write it down) and basically started adding unit testing, separated the tests I would need for this application.
This can be tested also in automated testing - for stress testing, load testing, etc... It can be also done with integration testing for how the components work together.
But I focused on unit testing for the main components: Repository and Service layers.
I have created a centralized fake implementations for testing Repository and Service layers so we can have some reusable parts.
Changed part of README.md

Overview
--------
- .NET target: .NET 8
- Minimal API (Program.cs)
- Repository: calls Hacker News API endpoints and caches results
- Service: orchestrates fetching, concurrency control and sorting
- Web: maps domain models to view models and exposes the HTTP endpoint
- TestFixtures: shared fake data used by unit tests
- Unit tests: Repository and Service layers (no external network required)

Project layout
--------------
- Santander.Hacker.News.Web         — Minimal API and endpoint(s)
- Santander.Hacker.News.Services    — Business logic (IStoryService / StoryService)
- Santander.Hacker.News.Repositories — HTTP access (IHackerNewsRepository / HackerNewsRepository)
- Santander.Hacker.News.Domains     — Domain models (Story)
- Santander.Hacker.News.TestFixtures — Reusable fake data for tests
- Santander.Hacker.News.*.UnitTests — Unit tests (Service + Repository + Web)

Key features
------------
- GET /api/v1/stories/best?limit={n}
  - limit: optional integer, defaults to 10, allowed range 1..100
  - Returns JSON array of StoryViewModel items (title, uri, postedBy, time (ISO 8601), score, commentCount)
  - Response includes header `X-Api-Version: 1.0`
- Caching: IMemoryCache for best-ids and individual items
- Concurrency: SemaphoreSlim in StoryService to bound parallel calls
- Rate limiting: built-in .NET RateLimiter applied per-client IP (configurable)
- Mapping: AutoMapper profiles live in Web.AutoMappers and are registered centrally
- Tests: use FakeHackerNewsData to avoid network calls

Configuration
-------------
appsettings.json (or environment variables) controls the Hacker News base URL:

  "HackerNews": {
    "BaseUrl": "https://hacker-news.firebaseio.com/v0/"
  }

Environment variable override (example):
- Windows PowerShell:
  $env:HackerNews__BaseUrl = "https://..."
- Linux / macOS:
  export HackerNews__BaseUrl="https://..."

Important implementation details
--------------------------------
- HttpClient: the project registers a named client "hackernews" and the repository uses IHttpClientFactory.CreateClient("hackernews"). Keep registration and usage consistent (named client) — do not mix typed and named registrations for the same service unless you change the repository accordingly.
- Mapping: AutoMapper is used; alternatively Mapster is an efficient, license-free option if you want to avoid AutoMapper.
- Rate limiting and concurrency:
  - RateLimiter controls requests per time window (token bucket)
  - SemaphoreSlim bounds concurrent outbound fetches
  - Both are complementary: token bucket controls throughput, SemaphoreSlim controls in-flight concurrency

How to run (local)
------------------

The easiest way to run is opening it with VS2022 is opening this solution and running the Santander.Hacker.News.Web as the startup project.
Can be using Docker container or directly with IIS Express.

Another alternative is using the command line:

1. Restore and build
   dotnet restore
   dotnet build

2. Run the Web project
   dotnet run --project Santander.Hacker.News.Web

3. Swagger UI (when running in Development)
   https://localhost:{port}/swagger

Run tests
---------
From the solution root:
  dotnet test

Packages (recommended)
----------------------
- Swashbuckle.AspNetCore (Swagger)
- AutoMapper
- AutoMapper.Extensions.Microsoft.DependencyInjection
- Microsoft.Extensions.Caching.Memory
- Microsoft.AspNetCore.Mvc.Testing (tests)
- Microsoft.AspNetCore.TestHost (tests)
- NUnit, NUnit3TestAdapter, Microsoft.NET.Test.Sdk (tests)
- Polly (optional for HttpClient resilience)
- If you find LuckyPennySoftware.AutoMapper in your graph, remove it and install the official AutoMapper packages:
  dotnet remove <project> package LuckyPennySoftware.AutoMapper
  dotnet add <project> package AutoMapper
  dotnet add <project> package AutoMapper.Extensions.Microsoft.DependencyInjection

Testing notes
-------------
- Unit tests use FakeHackerNewsData from the TestFixtures project — tests run quickly and deterministically without network I/O.
- Repository unit tests stub HttpClient by injecting a custom HttpMessageHandler that returns fixture JSON.
- Web layer tests use WebApplicationFactory with a fake IStoryService to isolate endpoint behavior.

Troubleshooting
---------------
- Invalid request URI / BaseAddress errors: ensure the registered HttpClient has BaseAddress set if the repository uses relative paths (or change the repository to use a typed HttpClient with BaseAddress).
- OpenAPI / WithOpenApi TypeLoadException: ensure Swashbuckle and Microsoft.OpenApi versions are compatible; remove explicit Microsoft.OpenApi package if it causes conflicts and install Swashbuckle.AspNetCore instead.
- Licensing: remove any third-party mapping packages that require production licenses (LuckyPennySoftware.AutoMapper) and replace with community/open alternatives.

Extending the project
---------------------
- Move static tuning values (MaxLimit, MaxIdsToFetch, MaxParallelism, rate-limiter settings) to configuration and bind with options pattern for environment-specific tuning and hot reload.
- Add Polly policies (retry + jitter, timeout, circuit-breaker) to the HttpClient registration for better resilience against transient failures.
- Add per-version Swagger docs if you adopt a more advanced versioning scheme later.
- Add integration and load tests for end-to-end verification and performance testing.

References
----------
- Hacker News API: https://github.com/HackerNews/API
- AutoMapper: https://automapper.org/
- .NET Rate Limiting: https://learn.microsoft.com/dotnet/standard/threading/rate-limiting

Contact / Notes
---------------
This README is intended to help reviewers run and understand the solution quickly. If you want changes (e.g., swap AutoMapper for Mapster, add Polly/Polly.Extensions.Http, or move settings to options), I can patch the code and tests accordingly.