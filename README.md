# Santander.Hacker.News
=============================

Author's notes for this solution
--------

Hello! This is a sample solution for a coding exercise involving the Hacker News API.
There are many things to consider in here:
    - I have used Copilot to help me - as you can notice in some parts - and I as informed is not a problem to use it.
    - Also, since there is not a strict time limit I tried to cover as max. as I can of different aspects of this solution.
    - My comments have TM (Tito Morais) added to the code, you will find in different places - so you can differentiate from copilot and my comments
    - I always double-check the code generated by Copilot, and I make sure I understand the core concepts of it.
    - The architecture and how the solution is structured is something I have designed myself.
    - Part of this README.md is generated by me, part of it is generated by Copilot, and I have edited it to make sure it makes sense.

So basically this is a solution that returns the top N "best" stories from Hacker News, sorted by score.
I have used .Net 8, Minimal APIs, AutoMapper, in-memory caching, and a simple per-client rate limiter.

For this part of requirements:
    You should share a public repository with us, that should include a README.md file which describes how to run the application, any assumptions you have made, and
    any enhancements or changes you would make, given the time.

I am going to explain partially what I tought in each day and also taking into consideration that there was no time limit presented.

Day 1:
I started coding it yesterday, 17/11/2025 after work, at 20:00 and finished at around 23:30.
In terms of architecture, I have separated the solution into layers: Repository, Service, and Web-layer.
It is using Docker for portability, it is using the out-of-the-box when creating a new solution with minial-API.
This is a layered architecture-style that is easy to understand, but this solution can be used as part of a service-based architecture, microservice architecture, etc...
I started using minimal API because there are not so many endpoints, and we don't need the full capabilities of Web API controllers.
After creating the architecture and having in my mind what should be in each project, I started doing the basic of the endpoint, after adding the Domain, after the Repository and at the Services.
After that, I added AutoMapper to map the domain models to view models.
Later I added rate-limiting to the endpoint.

For this part of requirements:
    In addition to the above, your API should be able to efficiently service large numbers of requests without risking overloading of the Hacker News API.

We have:
    - caching for efficiency, to avoid calling the Hacker News API too often.
    - rate-limiting to avoid overloading the Hacker News API.
    - Semaphoreslim to limit the number of concurrent requests to the Hacker News API.
    - HttpClientFactory to manage the HttpClient instances efficiently.
    - Async/await to avoid blocking threads.
    - locked collections - maybe we could use ConcurrentList or ConcurrentDictionary, but I have used simple lists with locks for simplicity.

Day 2:
Today, 18/11/2025, I started at around 09:30 (now is 12:13, lunch break from my work - I took this spare time to write it down) and basically started adding unit testing, separated the tests I would need for this application.
This can be tested also in automated testing - for stress testing, load testing, etc... It can be also done with integration testing for how the components work together.
But I focused on unit testing for the main components: Repository and Service layers.
I have created a centralized fake implementations for testing Repository and Service layers so we can have some reusable parts.


Overview
--------
This solution exposes a small REST API that returns the top N "best" Hacker News stories (as provided by the Hacker News API),
sorted by score (descending). The web project uses a Repository → Service → Web-layer separation, AutoMapper for mapping
domain models to view models, in-memory caching, and a simple per-client rate limiter.

Project layout (relevant projects)
- Santander.Hacker.News.Web       : Minimal API (Program.cs), Swagger, AutoMapper registration, endpoint(s).
- Santander.Hacker.News.Services : Business logic (IStoryService / StoryService).
- Santander.Hacker.News.Repositories : Hacker News HTTP access (IHackerNewsRepository / HackerNewsRepository).
- Santander.Hacker.News.Domains  : Domain models (Story).
- Santander.Hacker.News.Web.UnitTests : Integration/unit tests (WebApplicationFactory + fake services).
- Santander.Hacker.News.Web.ViewModels : API view models (StoryViewModel).
- Santander.Hacker.News.Web.AutoMappers : AutoMapper registration classes.

Requirements
------------
- .NET 8 SDK
- Visual Studio 2022 or VSCode (optional)
- Internet access to query the Hacker News API (unless tests use fakes)

NuGet packages you should have (common)
- Swashbuckle.AspNetCore
- AutoMapper
- AutoMapper.Extensions.Microsoft.DependencyInjection
- Microsoft.Extensions.Caching.Memory
- Microsoft.AspNetCore.Mvc.Testing (for tests)
- Microsoft.AspNetCore.TestHost (for tests)
- NUnit, NUnit3TestAdapter, Microsoft.NET.Test.Sdk (for tests)
- Polly (optional for resilience)
If you see any LuckyPennySoftware.AutoMapper package, remove it and replace with the official AutoMapper packages.

Configuration
-------------
Configuration values live in appsettings.json (and can be overridden via environment variables).

Key setting:
  "HackerNews": {
    "BaseUrl": "https://hacker-news.firebaseio.com/v0/"
  }

You can override the base URL with environment variables:
  set HackerNews__BaseUrl="https://..."        (Windows PowerShell/DevShell)
  export HackerNews__BaseUrl="https://..."     (Linux/macOS)

How it works (high level)
-------------------------
- Repository calls Hacker News endpoints:
  - GET /v0/beststories.json -> list of story IDs
  - GET /v0/item/{id}.json -> story details
- Service fetches a capped number of IDs, fetches details with bounded concurrency, filters to "story" items,
  sorts by score (then by time), and returns the top N requested.
- Repository uses IMemoryCache to cache IDs and items briefly to reduce upstream calls.
- AutoMapper maps domain Story -> StoryViewModel for the API response.
- API endpoint exposes: GET /api/v1/stories/best?limit={n}

Endpoint: GET /api/v1/stories/best
----------------------------------
Query parameter:
- limit (int) — how many stories to return. Defaults to 10. Allowed range: 1..100.

Response (JSON array) — each element is StoryViewModel:
{
  "title": "…",
  "uri": "https://…",
  "postedBy": "username",
  "time": "2019-10-12T13:43:01+00:00",
  "score": 1716,
  "commentCount": 572
}

Example:
  curl "http://localhost:5000/api/v1/stories/best?limit=5" -H "Accept: application/json"

Rate limiting
-------------
The app can be configured with a token-bucket rate limiter (per-client IP) in Program.cs.
Default behaviour when rate-limited:
- HTTP 429 Too Many Requests
- Optional Retry-After header

Adjust TokenLimit / TokensPerPeriod / ReplenishmentPeriod in Program.cs to suit your needs.

Run locally
-----------

1. Restore packages and build:
   dotnet restore
   dotnet build

2. Run the web project (from solution root):
   dotnet run --project Santander.Hacker.News.Web

3. Open Swagger UI (if running in Development):
   https://localhost:{port}/swagger

Run tests
---------
From solution root:
  dotnet test

Notes & troubleshooting
-----------------------
- If you see "An invalid request URI..." or missing BaseAddress, ensure you register the HttpClient consistently:
  - Either use a typed client:
      builder.Services.AddHttpClient<IHackerNewsRepository, HackerNewsRepository>(c => c.BaseAddress = new Uri(...));
    and let the repository accept HttpClient in its ctor, or
  - Use a named client and call IHttpClientFactory.CreateClient("hackernews") in the repository.
  Do not mix both approaches for the same service.
- If you see a TypeLoadException for Microsoft.OpenApi.*: check Swashbuckle and Microsoft.OpenApi package versions.
  Remove any explicit old Microsoft.OpenApi package; install a Swashbuckle version compatible with .NET 8.
- If you see messages about LuckyPennySoftware.AutoMapper: remove that package and install the official AutoMapper packages:
  dotnet remove <project> package LuckyPennySoftware.AutoMapper
  dotnet add <project> package AutoMapper
  dotnet add <project> package AutoMapper.Extensions.Microsoft.DependencyInjection

Extending the project
---------------------
- Add more mappings: add a new Mapping class and register it in MappingProfiles.Map(cfg).
- Move rate-limit / HTTP client policy settings to configuration.
- Add Polly resiliency policies to HttpClient registration (retry, timeout, circuit-breaker).
- Add per-version Swagger docs if you later enable API versioning.

Contact / References
--------------------
- Hacker News API: https://github.com/HackerNews/API
- AutoMapper: https://automapper.org/
- .NET Rate Limiting: https://learn.microsoft.com/dotnet/standard/threading/rate-limiting

----