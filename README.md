# Santander.Hacker.News

## Author's notes for this solution ‚úçÔ∏è

Hello! This is a sample solution for a coding exercise involving the Hacker News API. There are many things to consider here:

- I have used Copilot to help me - as you can notice in some parts - and I as informed that it is not a problem to use it.
- Also, since there is no strict time limit, I tried to cover as max. as I can of different aspects of this solution.
- My comments have **TM** (Tito Morais) added to the code, you will find in different places, so you can differentiate from Copilot and my comments.
- I always double-check the code generated by Copilot, and I make sure I understand the core concepts of it.
- The architecture and how the solution is structured is something I have designed myself.
- Part of this **README.md** is generated by me, part of it is generated by Copilot, and I have edited it to make sure it makes sense.
- If I had more time, I would spend more time on testing, integration testing, and load testing.

So basically, this is a solution that returns the top N "best" stories from Hacker News, sorted by score. I have used .NET 8, Minimal APIs, AutoMapper, in-memory caching, and a simple per-client rate limiter.

For this part of the requirements:
You should share a public repository with us, which should include a README.md file which describes how to run the application, any assumptions you have made, and any enhancements or changes you would make, given the time.

I am going to explain partially what I thought each day and what was coming to my mind thought this time:

### Day 1 üóìÔ∏è
> Started at üóìÔ∏è **17/11/2025** ¬∑ üïí **20:00 ‚Äì 23:30**

What I did (step-by-step)
1. Architectural decisions
   - Defined a small layered layout: Repository ‚Üí Service ‚Üí Web (minimal API).
   - Chose in-memory caching, HttpClientFactory and SemaphoreSlim for concurrency control.

2. Project and domain setup
   - Created projects and added the domain model (Story).
   - Added a TestFixtures project placeholder for later test data.

3. Repository implementation
   - Implemented IHackerNewsRepository and HackerNewsRepository.
   - Used IHttpClientFactory (named client) for calls to Hacker News.
   - Added IMemoryCache for best-ids and item caching.
   - Added basic error handling and logging.

4. Service implementation
   - Implemented IStoryService / StoryService that:
     - Retrieves best story IDs via repository.
     - Fetches item details with bounded concurrency (SemaphoreSlim).
     - Filters to "story" items and sorts by score/time.
     - Enforces limit validation (1..MaxLimit).

5. Web/API surface
   - Added the minimal API endpoint GET /api/v1/stories/best?limit={n}.
   - Registered services and memory cache in DI.
   - Registered a named HttpClient for the Hacker News base URL.
   - Configured Swagger/OpenAPI for local discovery.

6. Mapping and presentation
   - Added AutoMapper mapping (Story ‚Üí StoryViewModel) and centralized mapping registration.

7. Basic resilience & safety
   - Added simple safeguards: input validation, bounded concurrency, caching, and a rate-limit policy prepared for the endpoint.
   - Implemented basic Problem/HTTP error mapping (502, 400, 500) for upstream failures.

8. Manual verification
   - Ran the app locally, exercised the endpoint and Swagger, corrected issues (HttpClient registration, caching keys).

### Day 2 üóìÔ∏è
> Started at üóìÔ∏è **18/11/2025** ¬∑ üïí **08:00 ‚Äì 09:00** and **12:00 ‚Äì 12:30**

What I did (step-by-step)
1. Test fixtures and reusable data
   - Implemented FakeHackerNewsData (TestFixtures) with deterministic IDs and Story objects to drive unit tests.

2. Service unit tests
   - Added StoryService unit tests using Moq to mock IHackerNewsRepository.
   - Reused FakeHackerNewsData for consistent test scenarios (sorting, filtering, edge-cases).

3. Repository unit tests
   - Added repository tests that stub HttpClient using a custom TestHttpMessageHandler and a SimpleHttpClientFactory.
   - Verified GetBestStoryIdsAsync, GetItemAsync, caching and unknown-id behavior using fixture JSON.

4. Web layer tests
   - Added WebApplicationFactory-based tests for Program.cs endpoint.
   - Replaced IStoryService with a test fake to isolate the HTTP surface and mapping.

5. CI/test readiness
   - Ensured test projects reference required packages (NUnit, Microsoft.AspNetCore.Mvc.Testing, Moq).
   - Kept tests deterministic and isolated (no external network calls).

6. Notes / follow-ups
   - Documented how to run tests and the purpose of the TestFixtures.
   - Identified next improvements (Polly policies, distributed rate limiter, config-driven tuning).

### Day 3 üóìÔ∏è
> Started it on different times of the day at üóìÔ∏è **19/11/2025** 

What I did (step-by-step)

1. Improved this README.md
   - Formatted this document better
   - Added missing sections (Improvements, assumptions)
   - Improved the daily work description in here for better clarity


## Improvements if I had more time ‚ö†Ô∏è

- Tests
    - Problem: Not enought coverage of tests.
    - Mitigation: Add more Unit Tests, Integration Tests and Load Tests.
    
- Observability
    - Problem: No health checks, metrics or structured logging.
    - Mitigation: Add /health, request/latency metrics (Opentelemetry/Azure Insights), structured logs.

- Security
    - Problem: No authentication or API key; public endpoint can be abused.
    - Mitigation: Add optional API key / JWT auth, enforce per-key quotas.
    
- Resilience
  - Problem: No Polly policies or HttpClient timeouts; transient network errors may degrade behavior.
  - Mitigation: Add HttpClient timeout + Polly policies (retry, timeout, circuit-breaker).

- Rate limiting and caching
  - Problem: Rate limit and caching was added, but the values could be wrong.
  - Mitigation: Find a way to dynamically adjust rate limits based on observed upstream behavior; consider distributed cache (Redis) for multi-instance deployments.

- Dependency / licensing risk
  - Problem: Unexpected third-party packages (e.g., LuckyPenny) may require licenses or introduce supply-chain risk.
  - Mitigation: Audit dependencies, remove paid/suspicious packages and pin approved versions; add dependency scanning to CI.

- API contract and client friendliness
  - Problem: Endpoint returns only an array ‚Äî no pagination.
  - Mitigation: Consider pagination support.

- Configuration and operational tuning
  - Problem: Many tuning values are constants (MaxLimit, MaxIdsToFetch, MaxParallelism, rate-limiter settings).
  - Mitigation: Move to IOptions bound to appsettings and support environment overrides and hot-reload.

## Assumptions while developing this solution ‚ö†Ô∏è

- **Stable JSON contract** ‚Äî The Hacker News JSON schema is assumed stable (e.g., `score` is an integer). The code tolerates missing/null fields by using safe defaults (e.g., score = 0, commentCount = 0) but does not protect against breaking schema changes (type changes).
- **Only "story" items considered** ‚Äî Non-story item types (job, poll, comment, etc.) are filtered out by the service layer.
- **Limit parameter behavior** ‚Äî Query parameter `limit` defaults to 10 and is clamped to the inclusive range 1..100.
- **Rate limiting scope** ‚Äî Rate limiting is implemented per client IP using the built-in .NET RateLimiter middleware (in-process token-bucket).
- **Hacker News base URL is configurable** ‚Äî The upstream base URL is read from configuration (`HackerNews:BaseUrl`) but is assumed available in normal operation.
- **Upstream failures ‚Üí client response** ‚Äî If Hacker News is unreachable or returns errors, the API surfaces a 502 Bad Gateway (or uses cached data when available).
- **Sorting tie-breaker** ‚Äî When scores are equal, items are ordered by `time` descending (most recent first).
- **Caching expectations** ‚Äî Caching uses `IMemoryCache` (local to the process). TTLs are short by design to balance freshness and upstream load; in multi-instance deployments this should be replaced or complemented with a distributed cache (Redis).
- **Concurrency limits are process-local** ‚Äî `SemaphoreSlim` bounds concurrent outbound fetches per process ‚Äî not a global limit across multiple instances.
- **No authentication / public endpoint** ‚Äî The API is intentionally unauthenticated for the exercise; production usage would require API keys or other auth and per-key quotas.
- **Tests are deterministic** ‚Äî Unit tests use `FakeHackerNewsData` and stubbed `HttpClient` handlers so they run without external network calls.

Notes
- These assumptions aim to keep the example simple and focused on core behaviors (fetching, caching, concurrency, and presentation). Several are explicitly identified in the README as areas to improve for production readiness (observability, distributed caching, Polly policies, API keys).

This solution solves the problem ‚úÖ
-------

Using ASP.NET Core, implement a RESTful API to retrieve the details of the best n stories from the Hacker News API, as determined by their score, where n is specified by the caller to the API.

The Hacker News API is documented here: https://github.com/HackerNews/API.

The IDs for the stories can be retrieved from this URI:
https://hacker-news.firebaseio.com/v0/beststories.json

The details for an individual story ID can be retrieved from this URI:
https://hacker-news.firebaseio.com/v0/item/21233041.json (in this case for the story with ID 21233041)

The API should return an array of the best n stories as returned by the Hacker News API in descending order of score, in the form:

```
[
{
"title": "A uBlock Origin update was rejected from the Chrome Web Store",
"uri": "https://github.com/uBlockOrigin/uBlock-issues/issues/745",
"postedBy": "ismaildonmez",
"time": "2019-10-12T13:43:01+00:00",
"score": 1716,
"commentCount": 572
},
{ ... },
{ ... },
{ ... },
...
]
```

In addition to the above, your API should be able to efficiently service large numbers of requests without risking overloading of the Hacker News API.
You should share a public repository with us, that should include a README.md file which describes how to run the application, any assumptions you have made, and
any enhancements or changes you would make, given the time.

Overview üîé
--------
- .NET target: .NET 8
- Minimal API (Program.cs)
- Repository: calls Hacker News API endpoints and caches results
- Service: orchestrates fetching, concurrency control and sorting
- Web: maps domain models to view models and exposes the HTTP endpoint
- TestFixtures: shared fake data used by unit tests
- Unit tests: Repository and Service layers (no external network required)

Project layout üìÅ
--------------
- Santander.Hacker.News.Web         ‚Äî Minimal API and endpoint(s)
- Santander.Hacker.News.Services    ‚Äî Business logic (IStoryService / StoryService)
- Santander.Hacker.News.Repositories ‚Äî HTTP access (IHackerNewsRepository / HackerNewsRepository)
- Santander.Hacker.News.Domains     ‚Äî Domain models (Story)
- Santander.Hacker.News.TestFixtures ‚Äî Reusable fake data for tests
- Santander.Hacker.News.*.UnitTests ‚Äî Unit tests (Service + Repository + Web)

Key features ‚≠ê
------------
- GET /api/v1/stories/best?limit={n}
  - limit: optional integer, defaults to 10, allowed range 1..100
  - Returns JSON array of StoryViewModel items (title, uri, postedBy, time (ISO 8601), score, commentCount)
  - Response includes header `X-Api-Version: 1.0`
- Caching: IMemoryCache for best-ids and individual items
- Concurrency: SemaphoreSlim in StoryService to bound parallel calls
- Rate limiting: built-in .NET RateLimiter applied per-client IP (configurable)
- Mapping: AutoMapper profiles live in Web.AutoMappers and are registered centrally
- Tests: use FakeHackerNewsData to avoid network calls

Configuration üîß
-------------
appsettings.json (or environment variables) controls the Hacker News base URL:


```
  "HackerNews": {
    "BaseUrl": "https://hacker-news.firebaseio.com/v0/"
  }
```


Environment variable override (example):
- Windows PowerShell:

```
  $env:HackerNews__BaseUrl = "https://..."

```
- Linux / macOS:

```
  export HackerNews__BaseUrl="https://..."

```

Important implementation details ‚öôÔ∏è
--------------------------------
- HttpClient: the project registers a named client "hackernews" and the repository uses IHttpClientFactory.CreateClient("hackernews"). Keep registration and usage consistent (named client) ‚Äî do not mix typed and named registrations for the same service unless you change the repository accordingly.
- Mapping: AutoMapper is used; alternatively Mapster is an efficient, license-free option if you want to avoid AutoMapper.
- Rate limiting and concurrency:
  - RateLimiter controls requests per time window (token bucket)
  - SemaphoreSlim bounds concurrent outbound fetches
  - Both are complementary: token bucket controls throughput, SemaphoreSlim controls in-flight concurrency

How to run (local) ‚ñ∂Ô∏è
------------------

The easiest way to run is opening it with VS2022 is opening this solution and running the Santander.Hacker.News.Web as the startup project.
Can be using Docker container or directly with IIS Express.

Another alternative is using the command line:

1. Restore and build
   dotnet restore
   dotnet build

2. Run the Web project
   dotnet run --project Santander.Hacker.News.Web

3. Swagger UI (when running in Development)
   https://localhost:{port}/swagger

Run tests ‚úÖ
---------
From the solution root:
  dotnet test

Packages (recommended) üì¶
----------------------
- Swashbuckle.AspNetCore (Swagger)
- AutoMapper
- AutoMapper.Extensions.Microsoft.DependencyInjection
- Microsoft.Extensions.Caching.Memory
- Microsoft.AspNetCore.Mvc.Testing (tests)
- Microsoft.AspNetCore.TestHost (tests)
- NUnit, NUnit3TestAdapter, Microsoft.NET.Test.Sdk (tests)
- Polly (optional for HttpClient resilience)
- If you find LuckyPennySoftware.AutoMapper in your graph, remove it and install the official AutoMapper packages:
  dotnet remove <project> package LuckyPennySoftware.AutoMapper
  dotnet add <project> package AutoMapper
  dotnet add <project> package AutoMapper.Extensions.Microsoft.DependencyInjection

## Testing notes üß™
- Unit tests use `FakeHackerNewsData` from the `TestFixtures` project ‚Äî tests run quickly and deterministically without network I/O.
- Repository unit tests stub `HttpClient` by injecting a custom `HttpMessageHandler` that returns fixture JSON.
- Web layer tests use `WebApplicationFactory` with a fake `IStoryService` to isolate endpoint behavior.

## Troubleshooting ‚ö†Ô∏è
- Invalid request URI / BaseAddress errors: ensure the registered `HttpClient` has `BaseAddress` set if the repository uses relative paths (or change the repository to use a typed `HttpClient` with `BaseAddress`).
- OpenAPI / `WithOpenApi` `TypeLoadException`: ensure Swashbuckle and `Microsoft.OpenApi` versions are compatible; remove explicit `Microsoft.OpenApi` package if it causes conflicts and install `Swashbuckle.AspNetCore` instead.
- Licensing: remove any third-party mapping packages that require production licenses (`LuckyPennySoftware.AutoMapper`) and replace with community/open alternatives.

## Extending the project üî≠
- Move static tuning values (`MaxLimit`, `MaxIdsToFetch`, `MaxParallelism`, rate-limiter settings) to configuration and bind with options pattern for environment-specific tuning and hot reload.
- Add Polly policies (retry + jitter, timeout, circuit-breaker) to the `HttpClient` registration for better resilience against transient failures.
- Add per-version Swagger docs if you adopt a more advanced versioning scheme later.
- Add integration and load tests for end-to-end verification and performance testing.

## References üìö
- Hacker News API: https://github.com/HackerNews/API
- AutoMapper: https://automapper.org/

## Contact / Notes üí¨
This README is intended to help reviewers run and understand the solution quickly. If you want changes (e.g., swap AutoMapper for Mapster, add Polly/Polly.Extensions.Http, or move settings to options), I can patch the code and tests accordingly.
